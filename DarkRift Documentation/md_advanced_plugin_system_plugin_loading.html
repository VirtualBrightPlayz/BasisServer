<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DarkRift: Plugin Loading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dr2_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="dr2_logo.svg"/></td>
  <td id="projectalign">
   <div id="projectname">DarkRift<span id="projectnumber">&#160;2.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_advanced_plugin_system_plugin_loading.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Plugin Loading </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The following steps describe how DarkRift loads plugins. This can be useful to know when debugging errors loading plugins or their dependencies.</p>
<ol type="1">
<li>Types inheriting from <code>PluginBase</code> are discovered and registered with the plugin factory from the following sources:<ol type="a">
<li>Any types specified directly in the configuration for the server. This includes any types the Unity integration finds in your project if you are using a Unity based server.</li>
<li>Types loaded from the DLLs found in the plugin search paths specified in configuration. See below for more detail.</li>
<li>The set list of types for internal plugins. These include the base commands, network listeners, etc.</li>
</ol>
</li>
<li>Instances of plugins are loaded (instantiated) from the plugin factory based on the configuration. Plugins are loaded in the following order:<ol type="a">
<li>Log writers</li>
<li>Metric writers</li>
<li>ServerRegistryConnectors</li>
<li>Plugins (i.e. those implementing <code>Plugin</code>)</li>
<li>Network listeners</li>
</ol>
</li>
<li>The loaded even is run on plugins</li>
</ol>
<h1><a class="anchor" id="autotoc_md145"></a>
Plugin Search Paths</h1>
<p >Plugin search path in configuration tell DarkRift where to find types that contain plugins.</p>
<p >Plugin search paths can point to a directory with one of more plugin files or a single DLL file. When a directory is specified, all subdirectories of that directory are also recursively searched. </p><div class="fragment"><div class="line"><span class="comment">&lt;!-- A directory is specified --&gt;</span></div>
<div class="line">&lt;<span class="keywordtype">pluginSearchPath</span> <span class="keyword">src</span>=<span class="stringliteral">&quot;LogWriters/&quot;</span> /&gt;</div>
<div class="line"><span class="comment">&lt;!-- A file is specified --&gt;</span></div>
<div class="line">&lt;<span class="keywordtype">pluginSearchPath</span> <span class="keyword">src</span>=<span class="stringliteral">&quot;NetworkListeners/MyListener.dll&quot;</span> /&gt;</div>
</div><!-- fragment --><p >When specifying a directory it is possible to instruct DR to create the directory if it does not exist. </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">pluginSearchPath</span> <span class="keyword">src</span>=<span class="stringliteral">&quot;LogWriters/&quot;</span> <span class="keyword">createDir</span>=<span class="stringliteral">&quot;true&quot;</span> /&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md146"></a>
Plugin Dependency Resolution</h2>
<p >When loading a DLL file, dependencies need to be resolved by DarkRift. By default, DarkRift will recursively search directories from the file that it is trying to load, however this behaviour can be altered. </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">pluginSearchPath</span> <span class="keyword">src</span>=<span class="stringliteral">&quot;LogWriters/&quot;</span> <span class="keyword">dependencyResolutionStrategy</span>=<span class="stringliteral">&quot;Standard&quot;</span> /&gt;</div>
</div><!-- fragment --><p >To clarify which libraries would be checked for dependencies for each of these values, consider the following file tree: </p><div class="fragment"><div class="line">src</div>
<div class="line">|- plugins</div>
<div class="line">|  |- a</div>
<div class="line">|  |  |- b</div>
<div class="line">|  |  |  |- lib_1.dll</div>
<div class="line">|  |  |</div>
<div class="line">|  |  | plugin.dll</div>
<div class="line">|  |</div>
<div class="line">|  |- c</div>
<div class="line">|  |  | lib_2.dll</div>
<div class="line">|  |</div>
<div class="line">|  |- lib_3.dll</div>
<div class="line">|</div>
<div class="line">|- DarkRiftServer.exe</div>
<div class="line">|- lib_4.dll</div>
</div><!-- fragment --><p> And the following search path: </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">pluginSearchPath</span> <span class="keyword">src</span>=<span class="stringliteral">&quot;plugins/&quot;</span> <span class="keyword">dependencyResolutionStrategy</span>=<span class="stringliteral">&quot;...&quot;</span> /&gt;</div>
</div><!-- fragment --><p> The table below shows what which libraries would be checked when loading plugin.dll.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">DependencyResolutionStrategy   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Libraries checked in example when loading plugin.dll    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Standard   </td><td class="markdownTableBodyNone">Uses the standard .NET assembly resolution with no enhancements. This strategy will search for dependencies for using the standard .NET rules detailed <a href="https://docs.microsoft.com/en-us/dotnet/framework/deployment/how-the-runtime-locates-assemblies">here</a>.   </td><td class="markdownTableBodyNone">Any library previously loaded    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">RecursiveFromFile   </td><td class="markdownTableBodyNone">Recursively searches all subdirectories of each file's containing folder in addition to the standard .NET assembly resolution. This strategy will search for dependencies for using the standard .NET rules detailed <a href="https://docs.microsoft.com/en-us/dotnet/framework/deployment/how-the-runtime-locates-assemblies">here</a> but with additional steps to search through each discovered file's containing folder and any subdirectory of it.   </td><td class="markdownTableBodyNone"><code>lib_1.dll</code>, any library previously loaded    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RecursiveFromDirectory   </td><td class="markdownTableBodyNone">Recursively searches all subdirectories of the folder's containing folder in addition to the standard .NET assembly resolution. This strategy will search for dependencies for using the standard .NET rules detailed <a href="https://docs.microsoft.com/en-us/dotnet/framework/deployment/how-the-runtime-locates-assemblies">here</a> but with additional steps to search through the specified directory and any subdirectory of it. This cannot be used when using a path to a file.   </td><td class="markdownTableBodyNone"><code>lib_1.dll</code>, <code>lib_2.dll</code>, <code>lib_3.dll</code>, any library previously loaded   </td></tr>
</table>
<p >Some apparent inconsistencies may appear as plugins are loaded by DarkRift. For example, if a dependency is found for the first plugin loaded then it will be available to every subsequent plugin loaded even if the subsequent plugin's dependency resolution strategy would not discover it when loaded on its own.</p>
<h1><a class="anchor" id="autotoc_md147"></a>
Loading Plugins</h1>
<p >Once plugins have been loaded into the plugin factory, all types of plugins are loaded by their manager based on the configuration provided to the server. This configuration allows you to specify which of the loaded plugins are instantiated and allows you to pass settings to the plugins.</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">logWriters</span>&gt;</div>
<div class="line">  <span class="comment">&lt;!-- Specifying the log writer here marks it to be loaded --&gt;</span></div>
<div class="line">  &lt;<span class="keywordtype">logWriter</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;ConsoleWriter1&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;ConsoleWriter&quot;</span> <span class="keyword">levels</span>=<span class="stringliteral">&quot;info, warning, error, fatal&quot;</span> /&gt;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">&lt;!-- The log writer here is loaded with additional settings --&gt;</span></div>
<div class="line">  &lt;<span class="keywordtype">logWriter</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;FileWriter1&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;FileWriter&quot;</span> <span class="keyword">levels</span>=<span class="stringliteral">&quot;trace, info, warning, error, fatal&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">settings</span> <span class="keyword">file</span>=<span class="stringliteral">&quot;Logs/{0:d-M-yyyy}/{0:HH-mm-ss tt}.txt&quot;</span> /&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">logWriter</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">logWriters</span>&gt;</div>
</div><!-- fragment --><p >Additional settings can be passed to any type of plugin and become available in the constructor of the plugin: </p><div class="fragment"><div class="line"><span class="keyword">public</span> FileWriter(LogWriterLoadData logWriterLoadData) : base(logWriterLoadData)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Get the log directory from settings or use a default</span></div>
<div class="line">    LogFilePath = logWriterLoadData.Settings[<span class="stringliteral">&quot;file&quot;</span>] ?? <span class="stringliteral">&quot;my/default_path/&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p >Configuration is very similar for all types of plugins. The only differences are: Plugins inheriting from <code>Plugin</code> are, by default, loaded by default and have an additional <code>load</code> property which which to disable them, all other types of plugins are only loaded when specified; and some types have additional arguments that must be specified such as log writers which must have <code>name</code> and <code>levels</code> properties.</p>
<p >&lt;plugins&gt;</p>
<p >&lt;plugin type="HttpHealthCheck" load="false" &gt; &lt;/plugins&gt; </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
