<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DarkRift: Matchmaking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dr2_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="dr2_logo.svg"/></td>
  <td id="projectalign">
   <div id="projectname">DarkRift<span id="projectnumber">&#160;2.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_advanced_matchmaking.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Matchmaking </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >DarkRift Networking includes a matchmaker plugin for games where players need to be grouped into 'rooms' according to certain metrics. This page will guide you through using the matchmaker.</p>
<h1><a class="anchor" id="autotoc_md75"></a>
Matchmaker Setup</h1>
<p >The DarkRift matchmaker is implemented as an abstract plugin in the DarkRift.Server.Plugins.Matchmaking namespace. This means to use it you must inherit from it to provide it some basic implementation details including a ranking function and a type parameter.</p>
<p >The type parameter is required to set the type of object the matchmaker will be operating on. The matchmaker can match groups of any object type as some users may want to simply match IClients while some users may wish to match on their own player representations etc. The objects being matched by the matchmaker are known in DarkRift as 'entities' to generalise them from their actual type or purpose.</p>
<p >The ranking function is a method taking 2 entities and providing a value between 0 and 1 (inclusive) to rate how good a match between them would be. For example, if they would be perfect in a group together it would return nearer 1, if they were OK for each other it might return 0.25-0.75 and if they were an appauling match with each other it would return nearer 0.</p>
<p >The following forms a very simple matchmaker that would match based on player's levels where the max level they can reach is 100. </p><div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">class </span>ExampleMatchmaker : RankingMatchmaker&lt;int&gt;</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">bool</span> ThreadSafe =&gt; <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Version Version =&gt; <span class="keyword">new</span> Version(1, 0, 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> ExampleMatchmaker(PluginLoadData pluginLoadData) : base(pluginLoadData)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">float</span> GetSuitabilityMetric(<span class="keywordtype">int</span> entity1, <span class="keywordtype">int</span> entity2, MatchRankingContext&lt;int&gt; context)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> Math.Abs(entity1.Level - entity2.level) / 100f;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> Lastly, in order for the matchmaker to work you need to specify a number of settings in the configuration file. Add the following to the plugins element: </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">plugin</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;ExampleMatchmaker&quot;</span> <span class="keyword">load</span>=<span class="stringliteral">&quot;true&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">settings</span> <span class="keyword">discardThreshold</span>=<span class="stringliteral">&quot;0.2&quot;</span></div>
<div class="line">            <span class="keyword">groupDiscardThreshold</span>=<span class="stringliteral">&quot;0.2&quot;</span></div>
<div class="line">            <span class="keyword">entitiesPerGroup</span>=<span class="stringliteral">&quot;4&quot;</span></div>
<div class="line">            <span class="keyword">tickPeriod</span>=<span class="stringliteral">&quot;500&quot;</span> /&gt;</div>
<div class="line">&lt;/<span class="keywordtype">plugin</span>&gt;</div>
</div><!-- fragment --><p> Since some of these options are quite complex they are documented in detail in a section below.</p>
<h1><a class="anchor" id="autotoc_md76"></a>
Using the Matchmaker</h1>
<p >The matchmaker is accessible from your plugins like any other plugin is. Once you have a reference you can using the IMatchmaker interface to abstract the type of matchmaker away from your plugin.</p>
<p >The IMatchmaker interface provides the basic Enqueueing methods and the GroupFormed event which will be invoked everytime a satisfactory group is found by the matchmaker. The enqueue methods also accept an individual callback and return an IMatchmakerQueueTask which allows you to query the state of the entities you queued, subscribe to events relating only to those entities, or cancel the matchmaking for that group.</p>
<p >A typical queue operation might look like the following where PlayerMatchmakingStateChangedHandler sends a message to inform the player about his status in the queue. </p><div class="fragment"><div class="line">IMatchmakerQueueTask&lt;Player&gt; task = matchmaker.Enqueue(</div>
<div class="line">    player,</div>
<div class="line">    MatchmakingStateChangedHandler</div>
<div class="line">);</div>
</div><!-- fragment --><p> It is also perfectly possible to queue groups of entities with very few changes to the code since individuals are simply considered in the matchmaker as a group of one. </p><div class="fragment"><div class="line">IMatchmakerQueueTask&lt;Player&gt; task = matchmaker.EnqueueGroup(</div>
<div class="line">    players,</div>
<div class="line">    MatchmakingStateChangedHandler</div>
<div class="line">);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md77"></a>
Matchmaker Configuration In Detail</h1>
<p >The matchmaker has a number of settings that must be configured in the Server.config file: discardThreshold, groupDiscardThreshold, entitiesPerGroup, and tickPeriod.</p>
<p >The discard threshold is a useful tuning parameter that allows you to prune large parts of the search tree. If any two entities have a suitability metric beneath the discard threshold then they will not be put in a group together. By setting this value higher you prune a larger portion of the search tree and hence the matchmaker will use less resources but players will have less potential matches, setting this value lower prunes less of the search tree and will have a a higher resource cost but players will have more potential matches. With more potential matches you are likely to see faster but less high quality matchmaking.</p>
<p >The group discard threshold operates similarly to the discard threshold but acts on the average suitability metrics between all players in the two groups being considered. If two groups are being considered to be matched and all players report suitability metrics above the discard threshold then those groups may be matched together, however if all returned suitability metrics were low (but just high enough over the discard threshold) the two groups may not be good matches. This group discard threshold allows those to be discarded to further prune the search tree.</p>
<p >Setting the group discard threshold lower than the discard threshold will cause it to have no effect.</p>
<p >The entities per group setting indicates how many entities there will be in the groups outputted.</p>
<p >The tick period is the time in milliseconds between matchmaker searches. Each tick the matchmaker will try to make as many groups as possible and when no more groups can be made it will wait until the next tick before it tries again. If a search is already in progress the tick will be skipped over.</p>
<p >Setting the tick period to be higher will allow more time for users to queue up for each search but could increase waiting times, setting the period lower may reduce the waiting times but there will be less users to match against so it could result in lower quality matches.</p>
<p >Balancing these values is essential to good matchmaking and will depend heavily on the rate entities queue and the tolerances allowable between suitability metrics.</p>
<h1><a class="anchor" id="autotoc_md78"></a>
Matchmaker Ranking Builder</h1>
<p >To assist in creating a good ranking function DarkRift provides the MatchmakerRankingBuilder. This class provides a set of methods for the common computations you might need to perform within a builder pattern-style interface.</p>
<p >When building the ranking the builder takes in weights for each metric you compare allowing you to add or reduce the emphasis on certain metrics. It's important for these weights to total 1.0 otherwise you may find the resulting ranking doens't make sense.</p>
<p >As an example, the following would try to minimise the difference in player's level and try to ensure they're not the same class, this is done with a 0.7-0.3 weighting. </p><div class="fragment"><div class="line">MatchmakerRankingBuilder builder = <span class="keyword">new</span> MatchmakerRankingBuilder();</div>
<div class="line"> </div>
<div class="line">builder.MinimiseDifference(entity1.Level, entity2.Level, 100, 0.7);</div>
<div class="line">builder.NotEqual(entity1.Class, entity2.Class, 0.3);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">return</span> builder.Ranking;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
