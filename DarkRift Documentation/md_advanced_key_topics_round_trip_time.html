<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DarkRift: Round Trip Time</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dr2_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="dr2_logo.svg"/></td>
  <td id="projectalign">
   <div id="projectname">DarkRift<span id="projectnumber">&#160;2.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_advanced_key_topics_round_trip_time.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Round Trip Time </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Calculating the time it takes to send data between client and server is a critical part of many applications and is fundamental for all lag compensation code in games. DarkRift has some built in functionality for calculating the round trip time and ping between a client and the server.</p>
<h1><a class="anchor" id="autotoc_md70"></a>
Introduction</h1>
<p >Round trip time is calculated by sending a 'ping' from host <code>A</code> to <code>B</code> and, on reception at <code>B</code>, returning an acknowledgment from <code>B</code> to <code>A</code>. By timing this interaction <code>A</code> can calculate the 'round trip time', and from that estimate the 'ping time' by halving it.</p>
<p >To aid this DarkRift provides some additional fields in the <code>Message</code> type that allow a message to be sent as a 'ping' or 'ping acknowledgment' message. Furthermore, DarkRift will automatically time these messages and process the resulting times to smooth them.</p>
<p ><b>It's important to note that DarkRift does not send these messages for you</b>. Instead, any message can be converted to a ping message or ping acknowledgment so that you can use messages you already send to calculate the round trip time thus alleviating the need for additional messages to be sent just for this calculation.</p>
<p >Good candidates for conversion to ping messages are request-response type messages (where the response is generated quickly and can be used as the ping acknowledgment message), and messages that are sent regularly and consistently such as those sent from the main update loops.</p>
<h1><a class="anchor" id="autotoc_md71"></a>
Calculating the Round Trip Time</h1>
<p >To make a message a ping message you simply need to call <code>Message.MakePingMessage()</code>: </p><div class="fragment"><div class="line"><span class="keyword">using</span> (Message message = Message.Create(writer))</div>
<div class="line">{</div>
<div class="line">    message.MakePingMessage();</div>
<div class="line">    ...</div>
<div class="line">    client.SendMessage(message, SendMode.Unreliable);</div>
<div class="line">}</div>
</div><!-- fragment --><p >Calling <code>Message.MakePingMessage()</code> adds two additional bytes to the message that contain a 16 bit identifier for the ping message. This means that a ping acknowledgement message belongs uniquely to a ping message and cannot acknowledge the wrong ping message.</p>
<p >When sending the message the identifier will be automatically be stored with the time stamp at which it's send.</p>
<p >Upon receiving this message you should check if it is in fact a ping message and return a response as quickly as possible to avoid adding unnecessary time into the calculation.</p>
<p >To do this you can use the <code>IsPingMessage</code> property and the <code>MakePingAchnowledgementMessage(Message acknowledging)</code> method. </p><div class="fragment"><div class="line"><span class="keyword">using</span> (Message receivedMessage = args.GetMessage())</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (receivedMessage.IsPingMessage)</div>
<div class="line">    {</div>
<div class="line">        ...</div>
<div class="line">        <span class="keyword">using</span> (Message acknowledgementMessage = Message.Create(writer))</div>
<div class="line">        {</div>
<div class="line">            acknowledgementMessage.MakePingAcknowledgementMessage(receivedMessage);</div>
<div class="line">            ...</div>
<div class="line">            client.SendMessage(acknowledgementMessage, SendMode.Unreliable);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p >When the ping acknowledgement is received the timer will be stopped and the round trip time recorded automatically.</p>
<h1><a class="anchor" id="autotoc_md72"></a>
Using the Round Trip Time</h1>
<p >Both <a class="el" href="interface_dark_rift_1_1_server_1_1_i_client.html" title="Server representation of a client.">DarkRift.Server.IClient</a> and <a class="el" href="class_dark_rift_1_1_client_1_1_dark_rift_client.html" title="The client for DarkRift connections.">DarkRift.Client.DarkRiftClient</a> have an <code>RoundTripTime</code> property which contains both the <code>LatestRtt</code> and a <code>SmoothedRtt</code> which is a moving average of the most recent round trip times. The <code>SmoothedRtt</code> should be used if you want to reduce the weight of anomalous results at the cost of a slight delay.</p>
<div class="fragment"><div class="line">Logger.Info($<span class="stringliteral">&quot;Latest RTT was {client.RoundTripTime.Rtt} and the smoothed RTT was {client.RoundTripTime.SmoothedRtt} over {client.RoundTripTime.RttSampleCount} samples.&quot;</span>);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
