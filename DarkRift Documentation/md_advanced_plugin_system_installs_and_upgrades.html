<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DarkRift: Installs and Upgrades</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dr2_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="dr2_logo.svg"/></td>
  <td id="projectalign">
   <div id="projectname">DarkRift<span id="projectnumber">&#160;2.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_advanced_plugin_system_installs_and_upgrades.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Installs and Upgrades </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Often your plugins will require database tables and other things to be setup in order to work properly, it might be tempting to put these in the constructor but the problem with building all our tables in the constructor is that it will run every time DarkRift loads our plugin, which hence causes delays on startup. That’s not a problem for some applications when servers won’t be starting up and stopping regularly but what if we allocate a server instance for each room? That now adds delay to the start of each game while we needlessly connect to the database server to establish everything is already setup!</p>
<h1><a class="anchor" id="autotoc_md101"></a>
Installation</h1>
<p >To solve this DarkRift has a plugin installation system. Things like setting up DB tables, which only need to be done when we first run the plugin, can go in here and DarkRift will ensure it’s only called on that first run.</p>
<p >To do this we can override the virtual method in Plugin: </p><div class="fragment"><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Install(InstallEventArgs args)</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><p> This overrides the default installation routine (which does nothing) so you can supply our own logic, such as: </p><div class="fragment"><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Install(InstallEventArgs args)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using</span> (DbConnection db = OpenDatabaseConnection())    <span class="comment">//Open some arbitrary database connection from somewhere</span></div>
<div class="line">    {</div>
<div class="line">        db.Open();</div>
<div class="line">        <span class="keyword">using</span> (DbCommand command = db.CreateCommand())</div>
<div class="line">        {</div>
<div class="line">            command.CommandText = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS Scores (id INTEGER PRIMARY KEY AUTOINCREMENT, score INTEGER)&quot;</span>;</div>
<div class="line">            command.ExecuteNonQuery();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> And, in true DarkRift fashion, that’s all there is to it!</p>
<h1><a class="anchor" id="autotoc_md102"></a>
Upgrades</h1>
<p >But what happens if you need to change something you’ve already setup? If you change the version of your plugin (as specified on the properties we overrode at the start) then DarkRift will detect this and invoke the Upgrade method on your plugin so you can make the necessary changes without having to resort to checks in the constructor again!</p>
<p >To demonstrate this, let’s say we want to change the previously declared scores table to have a username field as well: </p><div class="fragment"><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Upgrade(UpgradeEventArgs args)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using</span> (DbConnection db = OpenDatabaseConnection())</div>
<div class="line">    {</div>
<div class="line">        db.Open();</div>
<div class="line">        <span class="keyword">using</span> (DbCommand command = db.CreateCommand())</div>
<div class="line">        {</div>
<div class="line">            command.CommandText = <span class="stringliteral">&quot;ALTER TABLE scores ADD username TEXT&quot;</span>;</div>
<div class="line">            command.ExecuteNonQuery();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> Do remember to change the version parameter to something higher for this to work however.</p>
<p >You can also query the arguments object to see which version was previously installed so you can ensure that you upgrade everything necessary even if you’re upgrading across multiple versions.</p>
<h1><a class="anchor" id="autotoc_md103"></a>
Loaded</h1>
<p >It's worth a quick note here that there is one other event, <code>Loaded</code>, which is called when the server has finished loading.</p>
<p >You may have found that you can't get and cache a plugin reference from the constructor as it throws an exception; this is because the order plugins are loaded in is not specified so there is no guaranetee the server knows about the plugin you're requesting yet.</p>
<p >Instead, this can be done in the <code>Loaded</code> event which guarantees all plugins have been loaded but the server will still not have been started yet so you know no other events will fire beforehand.</p>
<div class="fragment"><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Loaded(LoadedEventArgs args)</div>
<div class="line">{</div>
<div class="line">    base.Loaded(args);</div>
<div class="line"> </div>
<div class="line">    Logger.Info(<span class="stringliteral">&quot;Plugin was loaded&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
